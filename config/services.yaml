parameters:
    locale: pl
    mailer_from: "%env(resolve:MAILER_FROM)%"

imports:
    - { resource: services/doctrine.yaml }
    - { resource: services/messages.yaml }

services:
    _defaults:
        autowire: true
        autoconfigure: true
        bind:
            $environment: "%kernel.environment%"
            $mailerFrom: "%mailer_from%"

    Knp\Menu\FactoryInterface: "@knp_menu.factory"
    Knp\Snappy\GeneratorInterface: "@knp_snappy.pdf"
    SimpleBus\Message\Bus\MessageBus: "@transaction_wrapped_command_bus"
    Symfony\Component\HttpFoundation\Session\Session: "@session"
    Symfony\Component\Security\Core\Encoder\UserPasswordEncoderInterface: '@security.user_password_encoder.generic'

    Talesweaver\Integration\Symfony\Controller\:
        resource: "../src/Integration/Symfony/Controller/*"
        public: true

    Talesweaver\Integration\DataFixtures\ORM\:
        resource: "../src/Integration/DataFixtures/ORM/*"
        tags: ['doctrine.fixture.orm']

    Talesweaver\Integration\Symfony\:
        resource: "../src/Integration/Symfony/{Form,JSON,Mail,Menu,Pagination,Routing,Templating,Timeline,Security,Validation}/*"
        exclude: "../src/Integration/Symfony/Security/function/*"

    # Do not remove, because it is not explicitly used and is removed from the container
    Talesweaver\Integration\Symfony\JSON\EventParser:
        public: true

    # Menu
    app.menu.builder:
        class: Talesweaver\Integration\Symfony\Menu\Builder

    app.menu.main:
        class: Knp\Menu\MenuItem
        factory: ["@app.menu.builder", createMainMenu]
        tags:
            - { name: knp_menu.menu, alias: main }

    # Bus
    transaction_wrapped_command_bus:
        class: Talesweaver\Integration\Bus\TransactionWrappedBus
        decorates: command_bus
        arguments: ['@transaction_wrapped_command_bus.inner']

    author_aware_command_bus:
        class: Talesweaver\Integration\Bus\AuthorAwareBus
        decorates: transaction_wrapped_command_bus
        arguments: ['@author_aware_command_bus.inner']

    author_access_command_bus:
        class: Talesweaver\Integration\Bus\AuthorAccessBus
        decorates: author_aware_command_bus
        arguments: ['@author_access_command_bus.inner']

    messages_aware_bus:
        class: Talesweaver\Integration\Bus\MessagesAwareBus
        decorates: author_access_command_bus
        arguments: ['@messages_aware_bus.inner']

    # Security
    app.security.login_form_authenticator:
        class: Talesweaver\Integration\Symfony\Security\LoginFormAuthenticator

    Talesweaver\Integration\Symfony\Security\Request\SecuredInstanceParamConverter:
        arguments: [[]]
        autowire: false
        autoconfigure: false
        tags:
            - { name: request.param_converter, priority: 10 }
