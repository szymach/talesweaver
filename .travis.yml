language: php
php: 7.2
sudo: false
cache:
    yarn: true
    directories:
        - node_modules
        - vendor
addons:
    apt:
        sources:
            - mysql-5.7-trusty
        packages:
            - mysql-server
env:
    global:
        - SYMFONY_DEPRECATIONS_HELPER=weak
          DATABASE_URL=mysql://root@127.0.0.1:3306/talesweaver
          WKHTMLTOPDF_PATH=/usr/bin/wkhtmltopdf
          MAILER_URL=null://localhost
          MAILER_FROM=email@example.com
          APP_LOCALE=pl
          APP_ENV=test
          APP_SECRET=some_secret

before_install:
    - phpenv config-rm xdebug.ini
    - echo 'date.timezone = "Europe/Warsaw"' >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
    - "curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.7.0"
    - "export PATH=$HOME/.yarn/bin:$PATH"

install:
    - composer install -n
    - composer validate
    - "[ -f vendor/bin/deptrac.phar ] || curl -LS http://get.sensiolabs.de/deptrac.phar -o vendor/bin/deptrac.phar && chmod +x vendor/bin/deptrac.phar"
    - bin/console doctrine:database:create
    - bin/console doctrine:schema:create

script:
    - vendor/bin/phpcs
    - vendor/bin/deptrac.phar analyze --formatter-graphviz=0 config/layers.yml
    - bin/console lint:yaml config
    - bin/console lint:yaml translations
    - bin/console lint:twig templates
    - bin/console doctrine:schema:validate
    - vendor/bin/phpstan analyse -l 6 -c phpstan.neon src
    - vendor/bin/codecept run
    - bin/console doctrine:fixtures:load -n
    - APP_ENV=test php -d variables_order=EGPCS -S 127.0.0.1:8000 -t public > var/log/server.log 2>&1 &
    - yarn install
    - node_modules/.bin/webpack
    - node_modules/.bin/cypress run
